# create-customer-mq-soap-to-mq-json-v1

ACE application source code for MQ to JSON create customer application 


## Overview

This message flow GETS a SOAP/MQ message containing a 'customer-details' payload, generates a customer ID, converts the message to a JSON format, and then PUTs the resulting message to an output queue.

The application is designed to be used in conjunction with the update-datastore-mq-mongo-v1 application, which consumes the afforementioned JSON message and writes it into a system of record.

## Message flow nodes used in the flow

The message flow is very simple, comprising of only four message flow nodes.

![create-customer-mq-soap-to-mq-json-v1 overall message flow](https://github.ibm.com/cpat-agile-integration-sample/create-customer-mq-soap-to-mq-json-v1/blob/master/readme.images/overall-flow.png "create-customer-mq-soap-to-mq-json-v1 overall message flow")

### MQ Input

* **Queue Name:** CREATE.CUSTOMER.Q.V1
* **Policy:** CQM3 (connectivity to MQ via MQEndpoint Policy, not via the *MQ Connection* tab)
* **Input Message Parsing:** XMLNSC

### SOAP Extract

* Removes the SOAP envelope from the input message

### SoapToJson - Mapping Node

Converts the message from SOAP to JSON.

![SoapToJson - Mapping Node](https://github.ibm.com/cpat-agile-integration-sample/create-customer-mq-soap-to-mq-json-v1/blob/master/readme.images/mapping-node.png "SoapToJson - Mapping Node")

The following fields are copied over from the SOAP message:

* service_header (containing the brand)
* first_name
* last_name
* address

The following fields are added to the output message:

* A date and time stamp
* A unique userid, generated by custom Java class *UUIDGenerator.java*

![UUIDGenerator.java](https://github.ibm.com/cpat-agile-integration-sample/create-customer-mq-soap-to-mq-json-v1/blob/master/readme.images/UUIDGeneratorjava.png "UUIDGenerator.java")


### MQ Output

* **Queue Name:** UPDATE.DATASTORE.Q.V1
* **Policy:** CQM3 (connectivity to MQ via MQEndpoint Policy, not via the *MQ Connection* tab)

## Input message format and WSDL

The WSDL descriping the createCustomer SOAP service can be found [here](https://github.ibm.com/cpat-agile-integration-sample/create-customer-mq-soap-to-mq-json-v1/blob/master/MQSOAPTOMQJSON/createcustomer.wsdl "createCustomer wsdl").

The wsdl references the [createcustomer_InlineSchema1.xsd](https://github.ibm.com/cpat-agile-integration-sample/create-customer-mq-soap-to-mq-json-v1/blob/master/MQSOAPTOMQJSON/createcustomer_InlineSchema1.xsd "createCustomer request xsd") schema which describes the valid requests and responses. In this flow we are only validating against the request.

The request message body will contain the following fields:

| Header / body  | Field         | Type   | Max Length  |
| -------------- |:-------------:|:------:| -----------:|
| service_header | brand         | string | 25          |
| body           | first_name    | string | 25          |
| body           | last_name     | string | 25          |
| body           | adress        | string | 100         |

Here we can see an example input message:

```
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:cus="http://ibm.com/CustomerDetails/">
   <soapenv:Header/>
   <soapenv:Body>
      <cus:customer_details>
         <service_header>
            <brand>Tiger Bank</brand>
         </service_header>
         <first_name>Anthony</first_name>
         <last_name>Terry</last_name>
         <address>Glasgow</address>
      </cus:customer_details>
   </soapenv:Body>
</soapenv:Envelope>
```

A message such as this can be PUT on the input queue by your MQ client (such as rfhutilc) then the flow will consume and process it.


## Error Handling

Currently this flow does not have any error handling, but we hope to add this in future.